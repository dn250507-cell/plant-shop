<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ƒê·∫∑t H√†ng - C√¢y Gi·ªëng Vi·ªát</title>
    <link rel="stylesheet" href="css/style.css">
</head>

<body>
    <header class="header">
        <div class="header-content">
            <a href="index.html" class="logo">
                <span class="logo-icon">üåø</span>
                <span>C√¢y Gi·ªëng Vi·ªát</span>
            </a>
            <nav class="nav">
                <a href="index.html" class="nav-link">‚Üê Quay l·∫°i mua h√†ng</a>
            </nav>
        </div>
    </header>

    <div class="checkout-container">
        <h1 style="margin-bottom: 2rem;">üõí ƒê·∫∑t H√†ng</h1>

        <div class="checkout-grid">
            <!-- Order Form -->
            <div class="checkout-section">
                <h2 class="checkout-title">üìç Th√¥ng Tin Giao H√†ng</h2>

                <div id="alertBox" class="alert hidden"></div>

                <form id="checkoutForm" onsubmit="handleCheckout(event)">
                    <div class="form-group">
                        <label class="form-label" for="phone">S·ªë ƒëi·ªán tho·∫°i *</label>
                        <input type="tel" id="phone" class="form-input" placeholder="Nh·∫≠p s·ªë ƒëi·ªán tho·∫°i" required>
                    </div>

                    <div class="form-group">
                        <label class="form-label">ƒê·ªãa ch·ªâ giao h√†ng *</label>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                            <select id="city" class="form-input" required>
                                <option value="">Ch·ªçn T·ªânh/Th√†nh</option>
                            </select>
                            <select id="district" class="form-input" required>
                                <option value="">Ch·ªçn Qu·∫≠n/Huy·ªán</option>
                            </select>
                        </div>
                        <div style="margin-bottom: 1rem;">
                            <select id="ward" class="form-input" required>
                                <option value="">Ch·ªçn Ph∆∞·ªùng/X√£</option>
                            </select>
                        </div>
                        <input type="text" id="street" class="form-input" placeholder="S·ªë nh√†, t√™n ƒë∆∞·ªùng c·ª• th·ªÉ"
                            required>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="note">Ghi ch√∫</label>
                        <textarea id="note" class="form-input" rows="2"
                            placeholder="Ghi ch√∫ th√™m (t√πy ch·ªçn)"></textarea>
                    </div>

                    <button type="submit" class="btn btn-accent btn-lg" style="width: 100%; margin-top: 1rem;">
                        ‚úì X√°c Nh·∫≠n ƒê·∫∑t H√†ng
                    </button>
                </form>
            </div>

            <!-- Order Summary -->
            <div class="checkout-section">
                <h2 class="checkout-title">üåø S·∫£n Ph·∫©m</h2>

                <div id="cartItems">
                    <!-- Cart items will be rendered here -->
                </div>

                <div class="order-summary">
                    <div class="order-row">
                        <span>S·ªë l∆∞·ª£ng</span>
                        <span id="summaryQuantity">1</span>
                    </div>
                    <div class="order-row">
                        <span>ƒê∆°n gi√°</span>
                        <span id="summaryPrice">0ƒë</span>
                    </div>
                    <div class="order-row order-total">
                        <span>T·ªïng c·ªông</span>
                        <span id="summaryTotal">0ƒë</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="js/firebase-config.js"></script>

    <script src="js/auth.js"></script>
    <script src="js/plants.js"></script>
    <script src="js/cart.js"></script>

    <!-- No Google Maps API needed -->

    <script>
        let currentPlant = null;
        let quantity = 1;

        // Hosts for the API
        const PROVINCE_API = 'https://provinces.open-api.vn/api/';

        document.addEventListener('DOMContentLoaded', async () => {
            // Require login
            if (!AUTH.requireLogin()) return;

            // Load Province Data
            loadProvinces();

            const plantId = sessionStorage.getItem('checkout_plant');
            if (!plantId) {
                window.location.href = 'index.html';
                return;
            }

            try {
                // Fetch plant data asynchronously
                currentPlant = await PLANTS.getPlant(plantId);

                if (!currentPlant) {
                    alert('Kh√¥ng t√¨m th·∫•y s·∫£n ph·∫©m!');
                    window.location.href = 'index.html';
                    return;
                }

                // Pre-fill phone if logged in
                const user = AUTH.getCurrentUser();
                if (user && user.phone) {
                    document.getElementById('phone').value = user.phone;
                }

                renderCartItem();
            } catch (error) {
                console.error('Error loading plant:', error);
                alert('C√≥ l·ªói t·∫£i d·ªØ li·ªáu s·∫£n ph·∫©m');
            }
        });

        // ============================
        // ADDRESS HANDLERS
        // ============================
        async function loadProvinces() {
            try {
                const response = await fetch(PROVINCE_API + '?depth=1');
                const data = await response.json();
                renderOptions('city', data, 'T·ªânh/Th√†nh ph·ªë');
            } catch (e) { console.error('Error loading provinces', e); }
        }

        async function loadDistricts(provinceCode) {
            try {
                const response = await fetch(PROVINCE_API + 'p/' + provinceCode + '?depth=2');
                const data = await response.json();
                renderOptions('district', data.districts, 'Qu·∫≠n/Huy·ªán');
                document.getElementById('ward').innerHTML = '<option value="">Ch·ªçn Ph∆∞·ªùng/X√£</option>';
            } catch (e) { console.error('Error loading districts', e); }
        }

        async function loadWards(districtCode) {
            try {
                const response = await fetch(PROVINCE_API + 'd/' + districtCode + '?depth=2');
                const data = await response.json();
                renderOptions('ward', data.wards, 'Ph∆∞·ªùng/X√£');
            } catch (e) { console.error('Error loading wards', e); }
        }

        function renderOptions(id, data, label) {
            const select = document.getElementById(id);
            let html = `<option value="">Ch·ªçn ${label}</option>`;
            data.forEach(item => {
                html += `<option value="${item.code}" data-name="${item.name}">${item.name}</option>`;
            });
            select.innerHTML = html;
        }

        // Event Listeners for Dropdowns
        document.getElementById('city').addEventListener('change', function () {
            if (this.value) loadDistricts(this.value);
            else {
                document.getElementById('district').innerHTML = '<option value="">Ch·ªçn Qu·∫≠n/Huy·ªán</option>';
                document.getElementById('ward').innerHTML = '<option value="">Ch·ªçn Ph∆∞·ªùng/X√£</option>';
            }
        });

        document.getElementById('district').addEventListener('change', function () {
            if (this.value) loadWards(this.value);
            else document.getElementById('ward').innerHTML = '<option value="">Ch·ªçn Ph∆∞·ªùng/X√£</option>';
        });


        // ============================
        // CART LOGIC
        // ============================

        function renderCartItem() {
            const container = document.getElementById('cartItems');
            const imageContent = currentPlant.image
                ? `<img src="${currentPlant.image}" class="cart-item-image">`
                : '<div class="cart-item-image flex-center">üåø</div>';

            container.innerHTML = `
        <div class="cart-item">
          ${imageContent}
          <div class="cart-item-info">
            <div class="cart-item-name">${currentPlant.name}</div>
            <div class="cart-item-price">${PLANTS.formatPrice(currentPlant.price)}</div>
            <div class="text-muted" style="font-size: 0.875rem;">C√≤n ${currentPlant.stock} c√¢y</div>
          </div>
        </div>
        <div style="margin-top: 1rem;">
          <label class="form-label">S·ªë l∆∞·ª£ng</label>
          <div class="quantity-control">
            <button type="button" class="quantity-btn" onclick="changeQuantity(-1)">‚àí</button>
            <span class="quantity-value" id="quantityDisplay">${quantity}</span>
            <button type="button" class="quantity-btn" onclick="changeQuantity(1)">+</button>
          </div>
        </div>
      `;

            updateSummary();
        }

        function changeQuantity(delta) {
            const newQty = quantity + delta;
            if (newQty >= 1 && newQty <= currentPlant.stock) {
                quantity = newQty;
                document.getElementById('quantityDisplay').textContent = quantity;
                updateSummary();
            }
        }

        function updateSummary() {
            document.getElementById('summaryQuantity').textContent = quantity;
            document.getElementById('summaryPrice').textContent = PLANTS.formatPrice(currentPlant.price);
            document.getElementById('summaryTotal').textContent = PLANTS.formatPrice(currentPlant.price * quantity);
        }

        async function handleCheckout(e) {
            e.preventDefault();

            const phone = document.getElementById('phone').value.trim();

            // Get Address Components
            const cityEl = document.getElementById('city');
            const districtEl = document.getElementById('district');
            const wardEl = document.getElementById('ward');
            const streetEl = document.getElementById('street');

            const cityName = cityEl.options[cityEl.selectedIndex]?.text;
            const districtName = districtEl.options[districtEl.selectedIndex]?.text;
            const wardName = wardEl.options[wardEl.selectedIndex]?.text;
            const street = streetEl.value.trim();

            if (!cityEl.value || !districtEl.value || !wardEl.value || !street) {
                alert('Vui l√≤ng ch·ªçn ƒë·∫ßy ƒë·ªß ƒë·ªãa ch·ªâ (T·ªânh/Huy·ªán/X√£)');
                return;
            }

            const fullAddress = `${street}, ${wardName}, ${districtName}, ${cityName}`;
            const note = document.getElementById('note').value.trim();

            const btn = e.target.querySelector('button');
            const originalText = btn.textContent;
            btn.disabled = true;
            btn.textContent = 'ƒêang x·ª≠ l√Ω...';

            try {
                const result = await ORDERS.createOrder({
                    plantId: currentPlant.id,
                    quantity: quantity,
                    phone: phone,
                    address: fullAddress,
                    note: note
                });

                const alertBox = document.getElementById('alertBox');

                if (result.success) {
                    alertBox.classList.remove('hidden');
                    alertBox.className = 'alert alert-success';
                    alertBox.innerHTML = '‚úì ' + result.message + ' C·∫£m ∆°n b·∫°n ƒë√£ ƒë·∫∑t h√†ng!';

                    sessionStorage.removeItem('checkout_plant');

                    setTimeout(() => {
                        window.location.href = 'index.html';
                    }, 2000);
                } else {
                    alertBox.classList.remove('hidden');
                    alertBox.className = 'alert alert-error';
                    alertBox.innerHTML = '‚úï ' + result.message;
                    btn.disabled = false;
                    btn.textContent = originalText;
                }
            } catch (error) {
                console.error(error);
                btn.disabled = false;
                btn.textContent = originalText;
            }
        }
    </script>
</body>

</html>